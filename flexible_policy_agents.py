from langchain_openai import ChatOpenAI
from langchain.prompts import PromptTemplate
from langchain.schema import SystemMessage, HumanMessage
from langchain_core.documents import Document
from typing import Dict, List, Optional, TypedDict, Any
import json
from datetime import datetime
import uuid

class FlexiblePolicyState(TypedDict):
    """æŸ”è»Ÿãªæ”¿ç­–ç«‹æ¡ˆãƒ—ãƒ­ã‚»ã‚¹ã®çŠ¶æ…‹"""
    session_id: str
    project_id: Optional[str]
    analysis_result: Optional[str]
    objective_result: Optional[str]
    concept_result: Optional[str]
    plan_result: Optional[str]
    proposal_result: Optional[str]
    last_updated_step: Optional[str]
    step_dependencies: Dict[str, List[str]]
    step_timestamps: Dict[str, str]
    fact_search_results: List[str]
    conversation_history: List[Dict[str, str]]

class FlexiblePolicyAgentSystem:
    """æŸ”è»Ÿãªæ”¿ç­–ç«‹æ¡ˆæ”¯æ´AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ """
    
    def __init__(self, chat_model: ChatOpenAI, embedding_model=None, index=None):
        self.chat = chat_model
        self.embedding_model = embedding_model
        self.index = index
        
        # ã‚¹ãƒ†ãƒƒãƒ—é–“ã®ä¾å­˜é–¢ä¿‚å®šç¾©
        self.step_dependencies = {
            "analysis": [],
            "objective": ["analysis"],
            "concept": ["analysis", "objective"],
            "plan": ["analysis", "objective", "concept"],
            "proposal": ["analysis", "objective", "concept", "plan"]
        }
        
        # ãƒ¡ãƒ¢ãƒªå†…ã®çŠ¶æ…‹ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ï¼ˆæœ¬ç•ªã§ã¯ Redis ã‚„ DB ã‚’ä½¿ç”¨ï¼‰
        self.state_storage: Dict[str, FlexiblePolicyState] = {}
        
        # å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ¡ã‚½ãƒƒãƒ‰ã‚’ãƒãƒƒãƒ”ãƒ³ã‚°
        self.agent_map = {
            "analysis": self._analysis_agent,
            "objective": self._objective_agent,
            "concept": self._concept_agent,
            "plan": self._plan_agent,
            "proposal": self._proposal_agent,
        }
    
    def _get_session_state(self, session_id: str, project_id: str = None) -> FlexiblePolicyState:
        """ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’å–å¾—ã¾ãŸã¯åˆæœŸåŒ–"""
        if session_id not in self.state_storage:
            self.state_storage[session_id] = FlexiblePolicyState(
                session_id=session_id,
                project_id=project_id,
                analysis_result=None,
                objective_result=None,
                concept_result=None,
                plan_result=None,
                proposal_result=None,
                last_updated_step=None,
                step_dependencies=self.step_dependencies.copy(),
                step_timestamps={},
                fact_search_results=[],
                conversation_history=[]
            )
        return self.state_storage[session_id]
    
    def _update_session_state(self, session_id: str, step: str, result: str, user_input: str):
        """ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’æ›´æ–°"""
        state = self._get_session_state(session_id)
        
        # çµæœã‚’æ›´æ–°
        if step == "analysis":
            state["analysis_result"] = result
        elif step == "objective":
            state["objective_result"] = result
        elif step == "concept":
            state["concept_result"] = result
        elif step == "plan":
            state["plan_result"] = result
        elif step == "proposal":
            state["proposal_result"] = result
        
        # ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
        state["last_updated_step"] = step
        state["step_timestamps"][step] = datetime.now().isoformat()
        
        # å¯¾è©±å±¥æ­´ã‚’æ›´æ–°
        state["conversation_history"].append({"role": "user", "content": user_input})
        state["conversation_history"].append({"role": "assistant", "content": result})
        
        # å±¥æ­´ãŒå¤§ãããªã‚Šã™ããªã„ã‚ˆã†ã«æœ€æ–°20ä»¶ç¨‹åº¦ã«åˆ¶é™
        if len(state["conversation_history"]) > 20:
            state["conversation_history"] = state["conversation_history"][-20:]
            
        self.state_storage[session_id] = state
    
    def add_fact_search_result(self, session_id: str, fact_result: str):
        """ãƒ•ã‚¡ã‚¯ãƒˆæ¤œç´¢çµæœã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«è¿½åŠ """
        state = self._get_session_state(session_id)
        state["fact_search_results"].append(fact_result)
        self.state_storage[session_id] = state
    
    def _get_rag_context(self, query: str) -> List[Document]:
        """RAGæ¤œç´¢ã§ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—ï¼ˆRAGæ©Ÿèƒ½ã®å®Ÿè£…ã¯çœç•¥ï¼‰"""
        # å®Ÿéš›ã«ã¯ self.embedding_model ã¨ self.index ã‚’ä½¿ç”¨ã—ã¦æ¤œç´¢ã‚’è¡Œã†
        print("RAGæ¤œç´¢ã‚’å®Ÿè¡Œã—ã¾ã—ãŸã€‚ï¼ˆãƒ€ãƒŸãƒ¼ï¼‰")
        return []

    def _build_context_for_step(self, state: FlexiblePolicyState, current_step: str) -> str:
        """æŒ‡å®šã•ã‚ŒãŸã‚¹ãƒ†ãƒƒãƒ—ç”¨ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æ§‹ç¯‰"""
        context_parts = []
        
        # ãƒ•ã‚¡ã‚¯ãƒˆæ¤œç´¢çµæœã‚’è¿½åŠ 
        if state["fact_search_results"]:
            fact_context = "\\n\\n".join(state["fact_search_results"][-3:])
            context_parts.append(f"ã€å‚è€ƒï¼šãƒ•ã‚¡ã‚¯ãƒˆæ¤œç´¢çµæœã€‘\\n{fact_context}")
        
        # ä¾å­˜ã™ã‚‹ã‚¹ãƒ†ãƒƒãƒ—ã®çµæœã‚’å–å¾—
        dependencies = self.step_dependencies.get(current_step, [])
        for dep_step in dependencies:
            result = state.get(f"{dep_step}_result")
            if result:
                step_title = ""
                if dep_step == "analysis": step_title = "ç¾çŠ¶åˆ†æãƒ»èª²é¡Œæ•´ç†"
                elif dep_step == "objective": step_title = "ç›®çš„æ•´ç†"
                elif dep_step == "concept": step_title = "ã‚³ãƒ³ã‚»ãƒ—ãƒˆç­–å®š"
                elif dep_step == "plan": step_title = "æ–½ç­–ç«‹æ¡ˆ"
                elif dep_step == "proposal": step_title = "è³‡æ–™ä½œæˆ"
                context_parts.append(f"ã€ã“ã‚Œã¾ã§ã®æ¤œè¨å†…å®¹ï¼š{step_title}ã€‘\\n{result}")

        # ç›´è¿‘ã®å¯¾è©±å±¥æ­´ã‚’è¿½åŠ 
        if state["conversation_history"]:
            history_context = ""
            for msg in state["conversation_history"][-10:]:
                history_context += f"ã€{msg['role']}ã€‘: {msg['content']}\\n"
            context_parts.append(f"ã€ã“ã‚Œã¾ã§ã®å¯¾è©±å±¥æ­´ã€‘\\n{history_context}")
            
        return "\\n\\n".join(context_parts) if context_parts else ""

    def _classify_user_intent(self, user_input: str, state: FlexiblePolicyState) -> str:
        """
        ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›æ„å›³ã‚’åˆ†é¡ã™ã‚‹å†…éƒ¨ãƒ„ãƒ¼ãƒ«
        - 'step_action': ç‰¹å®šã®æ”¿ç­–ç«‹æ¡ˆã‚¹ãƒ†ãƒƒãƒ—ï¼ˆanalysis, objectiveãªã©ï¼‰ã«é–¢ã™ã‚‹å¯¾è©±
        - 'fact_search_request': ãƒ•ã‚¡ã‚¯ãƒˆæ¤œç´¢çµæœã®æ•´ç†ãƒ»è¦ç´„ã®è¦æ±‚
        - 'summary_request': ã“ã‚Œã¾ã§ã®è­°è«–ã®æ•´ç†ãƒ»è¦ç´„ã®è¦æ±‚
        - 'other': ãã®ä»–ï¼ˆé›‘è«‡ãªã©ï¼‰
        """
        messages = [
            SystemMessage(content="ã‚ãªãŸã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›æ„å›³ã‚’åˆ†é¡ã™ã‚‹AIã§ã™ã€‚é¸æŠè‚¢ã®ä¸­ã‹ã‚‰æœ€ã‚‚é©åˆ‡ãªåˆ†é¡åã‚’ä¸€ã¤ã ã‘å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚"),
            HumanMessage(content=f"""ä»¥ä¸‹ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ãŒã€æ¬¡ã®ã©ã®æ„å›³ã«è©²å½“ã™ã‚‹ã‹ã‚’åˆ¤æ–­ã—ã¦ãã ã•ã„ã€‚
<é¸æŠè‚¢>
- 'step_action': æ—¢å­˜ã®æ”¿ç­–ç«‹æ¡ˆã‚¹ãƒ†ãƒƒãƒ—ï¼ˆç¾çŠ¶åˆ†æã€ç›®çš„æ•´ç†ã€æ–½ç­–ç«‹æ¡ˆãªã©ï¼‰ã«é–¢ã™ã‚‹è­°è«–ã®ç¶™ç¶šã€‚
- 'fact_search_request': ãƒ•ã‚¡ã‚¯ãƒˆæ¤œç´¢ã§å¾—ãŸæƒ…å ±ã®è¦ç´„ã‚„æ•´ç†ã‚’æ±‚ã‚ã¦ã„ã‚‹ã€‚
- 'summary_request': ã“ã‚Œã¾ã§ã®å…¨ä½“ã®è­°è«–ã®è¦ç´„ã‚„æ•´ç†ã‚’æ±‚ã‚ã¦ã„ã‚‹ã€‚
- 'other': ä¸Šè¨˜ä»¥å¤–ã®ä¸€èˆ¬çš„ãªè³ªå•ã‚„é›‘è«‡ã€‚

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›:
{user_input}

æœ€ã‚‚é©åˆ‡ãªåˆ†é¡åï¼ˆ'step_action', 'fact_search_request', 'summary_request', 'other'ï¼‰ã‚’ä¸€ã¤ã ã‘å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
"""
            )
        ]
        response = self.chat.invoke(messages)
        intent = response.content.strip().replace("'", "").replace('"', '')
        return intent if intent in ['step_action', 'fact_search_request', 'summary_request', 'other'] else 'step_action'

    def _fact_summary_agent(self, user_input: str, state: FlexiblePolicyState) -> str:
        """ãƒ•ã‚¡ã‚¯ãƒˆæ¤œç´¢çµæœã‚’æ•´ç†ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ€è€ƒã‚’ä¿ƒã™å°‚ç”¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ"""
        if not state["fact_search_results"]:
            return "ç¾åœ¨ã€å‚ç…§ã§ãã‚‹ãƒ•ã‚¡ã‚¯ãƒˆæ¤œç´¢çµæœãŒã‚ã‚Šã¾ã›ã‚“ã€‚ã¾ãšãƒ•ã‚¡ã‚¯ãƒˆæ¤œç´¢ãƒœã‚¿ãƒ³ã‚’ä½¿ã£ã¦æƒ…å ±ã‚’å–å¾—ã—ã¦ãã ã•ã„ã€‚"

        fact_context = "\\n\\n".join(state["fact_search_results"][-5:])
        
        prompt = PromptTemplate(
            template="""ã‚ãªãŸã¯æ”¿ç­–ç«‹æ¡ˆã®å£æ‰“ã¡ç›¸æ‰‹ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ•ã‚¡ã‚¯ãƒˆæ¤œç´¢ã§å¾—ãŸæƒ…å ±ã‚’ã‚‚ã¨ã«ã€æ¬¡ã®å¯¾è©±ã‚’ä¿ƒã™å½¹å‰²ã‚’æ‹…ã„ã¾ã™ã€‚å˜ã«æƒ…å ±ã‚’è¦ç´„ã™ã‚‹ã ã‘ã§ãªãã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ€è€ƒã«ã©ã†å½¹ç«‹ã¤ã‹ã¨ã„ã†è¦–ç‚¹ã‚’åŠ ãˆã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚

ã€ãƒ•ã‚¡ã‚¯ãƒˆæ¤œç´¢ã§å¾—ã‚‰ã‚ŒãŸæƒ…å ±ã€‘
{fact_context}

ã€ã‚ãªãŸã®æ€è€ƒãƒ—ãƒ­ã‚»ã‚¹ã¨æŒ¯ã‚‹èˆã„ã€‘
1.  **æƒ…å ±ã®è¦ç´„ã¨æ•´ç†**: æä¾›ã•ã‚ŒãŸãƒ•ã‚¡ã‚¯ãƒˆæƒ…å ±ã‚’ç°¡æ½”ã«è¦ç´„ã—ã€è¦ç‚¹ã‚’ç®‡æ¡æ›¸ãã«ã™ã‚‹ã€‚
2.  **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®å•ã„ã‹ã‘**: è¦ç´„ã—ãŸæƒ…å ±ãŒã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç¾åœ¨å–ã‚Šçµ„ã‚“ã§ã„ã‚‹èª²é¡Œã‚„ä»®èª¬ã¨ã©ã†é–¢é€£ã™ã‚‹ã‹ã‚’å•ã„ã‹ã‘ã‚‹ã€‚
3.  **æ€è€ƒã®èª˜å°**: ã€Œã“ã®æƒ…å ±ã‹ã‚‰ã€ã‚ãªãŸã®å½“åˆã®ä»®èª¬ã«ä½•ã‹å¤‰æ›´ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿã€ã€Œã“ã®ãƒ‡ãƒ¼ã‚¿ã¯ã€ã©ã®èª²é¡Œã®è£ä»˜ã‘ã«ãªã‚Šãã†ã§ã™ã‹ï¼Ÿã€ã¨ã„ã£ãŸè³ªå•ã‚’æŠ•ã’ã‹ã‘ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ä¸»ä½“çš„ãªæ€è€ƒã‚’ä¿ƒã™ã€‚

ä¸Šè¨˜ã‚’è¸ã¾ãˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã‚’å—ã‘ãŸã‚ãªãŸã®å¿œç­”ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚""",
            input_variables=["fact_context"]
        )
        
        messages = [
            SystemMessage(content="ã‚ãªãŸã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ€è€ƒã‚’ä¿ƒã™å£æ‰“ã¡ç›¸æ‰‹ã§ã™ã€‚å¾—ã‚‰ã‚ŒãŸãƒ•ã‚¡ã‚¯ãƒˆæ¤œç´¢çµæœã‚’æ•´ç†ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è€ƒãˆã¨ç…§ã‚‰ã—åˆã‚ã›ã‚‹ã‚ˆã†ä¿ƒã—ã¦ãã ã•ã„ã€‚"),
            HumanMessage(content=prompt.format(fact_context=fact_context))
        ]
        
        response = self.chat.invoke(messages)
        return response.content.strip()

    def _overall_summary_agent(self, user_input: str, state: FlexiblePolicyState) -> str:
        """ã“ã‚Œã¾ã§ã®è­°è«–å…¨ä½“ã‚’æ•´ç†ã—ã€æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’ä¿ƒã™å°‚ç”¨ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ"""
        full_context = ""
        if state["analysis_result"]:
            full_context += f"ã€ç¾çŠ¶åˆ†æãƒ»èª²é¡Œæ•´ç†ã€‘\\n{state['analysis_result']}\\n\\n"
        if state["objective_result"]:
            full_context += f"ã€ç›®çš„æ•´ç†ã€‘\\n{state['objective_result']}\\n\\n"
        if state["concept_result"]:
            full_context += f"ã€ã‚³ãƒ³ã‚»ãƒ—ãƒˆç­–å®šã€‘\\n{state['concept_result']}\\n\\n"
        if state["plan_result"]:
            full_context += f"ã€æ–½ç­–ç«‹æ¡ˆã€‘\\n{state['plan_result']}\\n\\n"
        if state["proposal_result"]:
            full_context += f"ã€è³‡æ–™ä½œæˆã€‘\\n{state['proposal_result']}\\n\\n"
            
        if not full_context:
            return "ã¾ã è­°è«–ãŒå§‹ã¾ã£ã¦ã„ãªã„ã‚ˆã†ã§ã™ã€‚ã¾ãšã¯ä½•ã‹ã‚‰å§‹ã‚ã¾ã™ã‹ï¼Ÿ"

        prompt = PromptTemplate(
            template="""ã‚ãªãŸã¯æ”¿ç­–ç«‹æ¡ˆã®å£æ‰“ã¡ç›¸æ‰‹ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ±‚ã‚ã«å¿œã˜ã¦ã€ã“ã‚Œã¾ã§ã®è­°è«–å…¨ä½“ã‚’è¦ç´„ãƒ»æ•´ç†ã—ã€ç¾çŠ¶ã‚’å…±æœ‰ã™ã‚‹å½¹å‰²ã‚’æ‹…ã„ã¾ã™ã€‚å˜ã«è¦ç´„ã™ã‚‹ã ã‘ã§ãªãã€æ¬¡ã®è­°è«–ã‚’ã‚¹ãƒ ãƒ¼ã‚ºã«é€²ã‚ã‚‹ãŸã‚ã®è¦–ç‚¹ã‚’æç¤ºã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚

ã€ã“ã‚Œã¾ã§ã®è­°è«–ã®å…¨ä½“åƒã€‘
{full_context}

ã€ã‚ãªãŸã®æ€è€ƒãƒ—ãƒ­ã‚»ã‚¹ã¨æŒ¯ã‚‹èˆã„ã€‘
1.  **å…¨ä½“åƒã®è¦ç´„**: ã“ã‚Œã¾ã§ã®è­°è«–å†…å®¹ï¼ˆç¾çŠ¶ã€ç›®çš„ã€ã‚³ãƒ³ã‚»ãƒ—ãƒˆã€æ–½ç­–ãªã©ï¼‰ã‚’ç°¡æ½”ã«ç®‡æ¡æ›¸ãã§ã¾ã¨ã‚ã‚‹ã€‚
2.  **ç¾çŠ¶ã®èª²é¡Œç‰¹å®š**: è­°è«–ã®ã©ã®éƒ¨åˆ†ãŒä¸è¶³ã—ã¦ã„ã‚‹ã‹ã€çŸ›ç›¾ã¯ãªã„ã‹ã€ã¨ã„ã£ãŸã€Œç©´ã€ã‚’ç‰¹å®šã™ã‚‹ã€‚
3.  **æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ææ¡ˆ**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã€Œæ¬¡ã«ä½•ã‚’ã™ã¹ãã‹ã€ã‚’ä¿ƒã™ãŸã‚ã®å…·ä½“çš„ãªè³ªå•ã‚„ææ¡ˆã‚’æŠ•ã’ã‹ã‘ã‚‹ã€‚

ä¸Šè¨˜ã‚’è¸ã¾ãˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã‚’å—ã‘ãŸã‚ãªãŸã®å¿œç­”ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚""",
            input_variables=["full_context"]
        )
        
        messages = [
            SystemMessage(content="ã‚ãªãŸã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è­°è«–ã®å…¨ä½“åƒã‚’æ•´ç†ã—ã€æ¬¡ã®è¡Œå‹•ã‚’ä¿ƒã™ã‚µãƒãƒ¼ãƒˆAIã§ã™ã€‚"),
            HumanMessage(content=prompt.format(full_context=full_context))
        ]
        
        response = self.chat.invoke(messages)
        return response.content.strip()

    def _analysis_agent(self, user_input: str, state: FlexiblePolicyState) -> str:
        """ç¾çŠ¶åˆ†æãƒ»èª²é¡Œæ•´ç†ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆãƒ–ãƒ©ãƒƒã‚·ãƒ¥ã‚¢ãƒƒãƒ—ç‰ˆï¼‰"""
        context = self._build_context_for_step(state, "analysis")
        
        prompt = PromptTemplate(
            template="""ã‚ãªãŸã¯æ”¿ç­–ç«‹æ¡ˆã®ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªå£æ‰“ã¡ç›¸æ‰‹ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ€è€ƒã‚’æ§‹é€ åŒ–ã—ã€ç›²ç‚¹ã‚’æŒ‡æ‘˜ã—ã€æ–°ãŸãªè¦–ç‚¹ã‚’æä¾›ã™ã‚‹å½¹å‰²ã‚’æ‹…ã„ã¾ã™ã€‚å˜ãªã‚‹æƒ…å ±ã®æ•´ç†ã§ã¯ãªãã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ°—ã¥ã„ã¦ã„ãªã„æœ¬è³ªçš„ãªèª²é¡Œã‚’ç™ºè¦‹ã§ãã‚‹ã‚ˆã†å°ã„ã¦ãã ã•ã„ã€‚

ã€ã“ã‚Œã¾ã§ã®æ¤œè¨å†…å®¹ã€‘
{context}

ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®å…¥åŠ›ã€‘
{user_input}

ã€ã‚ãªãŸã®æ€è€ƒãƒ—ãƒ­ã‚»ã‚¹ã¨æŒ¯ã‚‹èˆã„ã€‘
1.  **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ„å›³ç†è§£**: ã¾ãšã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä»Šå›ã®ç™ºè¨€ãŒã€Œèª²é¡Œã®æ·±æ˜ã‚Šã€ã‹ã€Œå˜ãªã‚‹ç¾çŠ¶ã®ç¾…åˆ—ã€ã‹ã€ãã®æ„å›³ã‚’æ±²ã¿å–ã‚‹ã€‚
2.  **ç¾çŠ¶ã®æ•´ç†**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›å†…å®¹ã‚’ã€3ã¤ã®ã‚´ãƒ¼ãƒ«é …ç›®ï¼ˆèª²é¡Œã¨è£ä»˜ã‘ã€èƒŒæ™¯ã«ã‚ã‚‹æ§‹é€ ã€å„ªå…ˆåº¦ï¼‰ã«ç…§ã‚‰ã—åˆã‚ã›ã¦æ•´ç†ã™ã‚‹ã€‚
3.  **å¯¾è©±ã®æ–¹å‘æ€§æç¤º**: æ•´ç†ã—ãŸå†…å®¹ã«åŸºã¥ã„ã¦ã€æ¬¡ã®å¯¾è©±ã§æ·±æ˜ã‚Šã™ã¹ãç‚¹ã‚’ã€Œè³ªå•ã€ã¨ã—ã¦æç¤ºã™ã‚‹ã€‚
4.  **å•ã„ã®å…·ä½“åŒ–**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç­”ãˆã‚„ã™ã„ã‚ˆã†ã€å…·ä½“çš„ãªäº‹ä¾‹ã‚„åˆ‡ã‚Šå£ã‚’äº¤ãˆãªãŒã‚‰å•ã„ã‚’æŠ•ã’ã‹ã‘ã‚‹ã€‚ç­”ãˆã‚’ç›´æ¥æ•™ãˆã‚‹ã®ã§ã¯ãªãã€ãƒ¦ãƒ¼ã‚¶ãƒ¼è‡ªèº«ã«è€ƒãˆã•ã›ã‚‹ã“ã¨ã‚’å¾¹åº•ã™ã‚‹ã€‚

ã€é”æˆã™ã¹ãã‚´ãƒ¼ãƒ«ã€‘
ã“ã®å¯¾è©±ã‚’é€šã˜ã¦ã€æœ€çµ‚çš„ã«ä»¥ä¸‹ã®3ã¤ã®é …ç›®ãŒã¾ã¨ã¾ã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚
ğŸ“‹ **1. èª²é¡Œã¨è£ä»˜ã‘ï¼ˆå®šé‡ãƒ»å®šæ€§ï¼‰**
    ãƒ»**ç¢ºèªãƒã‚¤ãƒ³ãƒˆ**: ãã®èª²é¡Œã‚’è£ä»˜ã‘ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚„äº‹å®Ÿã¯ä½•ã§ã™ã‹ï¼Ÿå®¢è¦³çš„ãªæ ¹æ‹ ã¯ååˆ†ã§ã™ã‹ï¼Ÿ
    ãƒ»**æŠ•ã’ã‹ã‘ã‚‹ã¹ãè³ªå•ä¾‹**: ã€Œã“ã®èª²é¡Œã€ä¾‹ãˆã°ã©ã®ã‚ˆã†ãªæ•°å­—ã§ç¤ºã›ã¾ã™ã‹ï¼Ÿã€ã€Œãã®èª²é¡Œã‚’æ„Ÿã˜ãŸå…·ä½“çš„ãªã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿã€

ğŸ—ï¸ **2. èª²é¡Œã®èƒŒæ™¯ã«ã‚ã‚‹æ§‹é€ ï¼ˆåˆ¶åº¦ãƒ»å¸‚å ´ãªã©ï¼‰**
    ãƒ»**ç¢ºèªãƒã‚¤ãƒ³ãƒˆ**: èª²é¡Œã®æ ¹æœ¬åŸå› ã¯ä½•ã§ã™ã‹ï¼Ÿåˆ¶åº¦ã€ç¤¾ä¼šã€å¸‚å ´ã€æ–‡åŒ–ãªã©ã€æ§‹é€ çš„ãªè¦å› ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ
    ãƒ»**æŠ•ã’ã‹ã‘ã‚‹ã¹ãè³ªå•ä¾‹**: ã€Œã“ã®å•é¡Œã¯ã€ãªãœèµ·ã“ã£ã¦ã„ã‚‹ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿã€ã€Œãªã«ã‹æ³•åˆ¶åº¦ã‚„å•†ç¿’æ…£ãŒå½±éŸ¿ã—ã¦ã„ã¾ã›ã‚“ã‹ï¼Ÿã€

ğŸ¯ **3. è§£æ±ºã™ã¹ãèª²é¡Œã®å„ªå…ˆåº¦ã¨ç†ç”±**
    ãƒ»**ç¢ºèªãƒã‚¤ãƒ³ãƒˆ**: å…¨ã¦ã®èª²é¡Œã«å–ã‚Šçµ„ã‚€ã®ã¯é›£ã—ã„ã§ã™ã€‚æœ€ã‚‚ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆãŒå¤§ãã„ã®ã¯ã©ã‚Œã§ã™ã‹ï¼Ÿ
    ãƒ»**æŠ•ã’ã‹ã‘ã‚‹ã¹ãè³ªå•ä¾‹**: ã€Œã„ãã¤ã‹èª²é¡ŒãŒè¦‹ãˆã¦ãã¾ã—ãŸãŒã€ãã®ä¸­ã§ã‚‚ç‰¹ã«è§£æ±ºã™ã¹ãã€æ ¸ã€ã¨ãªã‚‹èª²é¡Œã¯ã©ã‚Œã ã¨ãŠè€ƒãˆã§ã™ã‹ï¼Ÿã€ã€Œãã®èª²é¡Œã‹ã‚‰å–ã‚Šçµ„ã‚€ã“ã¨ã§ã€ã©ã®ã‚ˆã†ãªæ³¢åŠåŠ¹æœãŒæœŸå¾…ã§ãã¾ã™ã‹ï¼Ÿã€

ä¸Šè¨˜ã‚’è¸ã¾ãˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã‚’å—ã‘ãŸã‚ãªãŸã®å¿œç­”ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚""",
            input_variables=["context", "user_input"]
        )
        
        messages = [
            SystemMessage(content="ã‚ãªãŸã¯æ€è€ƒæ•´ç†ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹å£æ‰“ã¡ç›¸æ‰‹ã§ã™ã€‚ç­”ãˆã‚„çµè«–ã¯å‡ºã•ãšã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è€ƒãˆã‚’æ•´ç†ã—ã€æ°—ã¥ãã‚’ä¿ƒã™ã“ã¨ã«å¾¹ã—ã¦ãã ã•ã„ã€‚"),
            HumanMessage(content=prompt.format(context=context, user_input=user_input))
        ]
        
        response = self.chat.invoke(messages)
        return response.content.strip()

    def _objective_agent(self, user_input: str, state: FlexiblePolicyState) -> str:
        """ç›®çš„æ•´ç†ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆãƒ–ãƒ©ãƒƒã‚·ãƒ¥ã‚¢ãƒƒãƒ—ç‰ˆï¼‰"""
        context = self._build_context_for_step(state, "objective")
        
        prompt = PromptTemplate(
            template="""ã‚ãªãŸã¯æ”¿ç­–ç«‹æ¡ˆã®ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªå£æ‰“ã¡ç›¸æ‰‹ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç›®çš„ãŒæ›–æ˜§ãªçŠ¶æ…‹ã‹ã‚‰ã€å…·ä½“çš„ã§è¨ˆæ¸¬å¯èƒ½ãªã‚´ãƒ¼ãƒ«ã¸ã¨ç£¨ãä¸Šã’ã‚‹å½¹å‰²ã‚’æ‹…ã„ã¾ã™ã€‚å˜ã«ã€Œä½•ã‚’ã—ãŸã„ã‹ã€ã ã‘ã§ãªãã€ã€Œãªãœãã‚Œã‚’ã—ãŸã„ã®ã‹ã€ã¨ã„ã†æœ¬è³ªçš„ãªå•ã„ã‚’æŠ•ã’ã‹ã‘ã€ç›®çš„ã®è§£åƒåº¦ã‚’é«˜ã‚ã‚‹ã‚ˆã†å°ã„ã¦ãã ã•ã„ã€‚

ã€ã“ã‚Œã¾ã§ã®æ¤œè¨å†…å®¹ã€‘
{context}

ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®å…¥åŠ›ã€‘
{user_input}

ã€ã‚ãªãŸã®æ€è€ƒãƒ—ãƒ­ã‚»ã‚¹ã¨æŒ¯ã‚‹èˆã„ã€‘
1.  **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ„å›³ç†è§£**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç™ºè¨€ãŒã€ã‚´ãƒ¼ãƒ«è¨­å®šã€KPIã®æ¤œè¨ã€ã‚ã‚‹ã„ã¯åˆ¶ç´„ã®ç¢ºèªã€ã©ã®æ®µéšã«ã‚ã‚‹ã‹ã‚’åˆ¤æ–­ã™ã‚‹ã€‚
2.  **ç›®çš„ã®æ˜ç¢ºåŒ–**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæç¤ºã—ãŸç›®çš„ãŒã€Œæœ€çµ‚çš„ã«ã©ã†ãªã£ãŸã‚‰æˆåŠŸã‹ã€ã‚’å•ã„ç›´ã™ã€‚
3.  **å¯¾è©±ã®æ–¹å‘æ€§æç¤º**: 3ã¤ã®ã‚´ãƒ¼ãƒ«é …ç›®ã«æ²¿ã£ã¦ã€æ¬¡ã«æ·±æ˜ã‚Šã™ã¹ããƒã‚¤ãƒ³ãƒˆã‚’å…·ä½“çš„ã«æç¤ºã™ã‚‹ã€‚
4.  **å•ã„ã®å…·ä½“åŒ–**: æ›–æ˜§ãªè¡¨ç¾ã‚’é¿ã‘ã‚‹ãŸã‚ã®è³ªå•ï¼ˆã€Œã€œã¨ã¯å…·ä½“çš„ã«ã©ã†ã„ã†ã“ã¨ã§ã™ã‹ï¼Ÿã€ï¼‰ã‚’æŠ•ã’ã‹ã‘ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¨€èªåŒ–ã‚’ä¿ƒã™ã€‚

ã€é”æˆã™ã¹ãã‚´ãƒ¼ãƒ«ã€‘
ã“ã®å¯¾è©±ã‚’é€šã˜ã¦ã€æœ€çµ‚çš„ã«ä»¥ä¸‹ã®3ã¤ã®é …ç›®ãŒã¾ã¨ã¾ã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚
ğŸ¯ **1. æœ€çµ‚çš„ã«é”æˆã—ãŸã„ã‚´ãƒ¼ãƒ«**
    ãƒ»**ç¢ºèªãƒã‚¤ãƒ³ãƒˆ**: èª°ã«ã¨ã£ã¦ã€ã©ã®ã‚ˆã†ãªå¤‰åŒ–ã‚’ã‚‚ãŸã‚‰ã™ã®ã‹ï¼Ÿãã®å¤‰åŒ–ã¯å…·ä½“çš„ã«ã©ã†æ¸¬å®šã§ãã‚‹ã®ã‹ï¼Ÿ
    ãƒ»**æŠ•ã’ã‹ã‘ã‚‹ã¹ãè³ªå•ä¾‹**: ã€Œã€ç¤¾ä¼šã®æ´»æ€§åŒ–ã€ã¨ã¯ã€å…·ä½“çš„ã«ã©ã‚“ãªçŠ¶æ…‹ã‚’æŒ‡ã—ã¾ã™ã‹ï¼Ÿã€ã€Œãã®ã‚´ãƒ¼ãƒ«ã¯ã€èª°ã«ã¨ã£ã¦ã€ã©ã‚“ãªã€å¬‰ã—ã„å¤‰åŒ–ã€ã‚’ã‚‚ãŸã‚‰ã—ã¾ã™ã‹ï¼Ÿã€

ğŸ“Š **2. KPIãƒ»ç›®æ¨™å€¤ï¼ˆã„ã¤ã¾ã§ã«ãƒ»ã©ã‚Œã ã‘ï¼‰**
    ãƒ»**ç¢ºèªãƒã‚¤ãƒ³ãƒˆ**: ç›®æ¨™é”æˆåº¦ã‚’å®¢è¦³çš„ã«è©•ä¾¡ã™ã‚‹ãŸã‚ã®æŒ‡æ¨™ã¯ä½•ã‹ï¼Ÿãã®æ•°å€¤ç›®æ¨™ã®æ ¹æ‹ ã¯ååˆ†ã‹ï¼Ÿ
    ãƒ»**æŠ•ã’ã‹ã‘ã‚‹ã¹ãè³ªå•ä¾‹**: ã€Œãã®ç›®æ¨™å€¤ã¯ã€ãªãœãã®æ•°å­—ãªã®ã§ã—ã‚‡ã†ã‹ï¼Ÿã€ã€Œç›®æ¨™ã‚’é”æˆã—ãŸã‹ã©ã†ã‹ãŒã€ç¬¬ä¸‰è€…ã«ã‚‚æ˜ç¢ºã«åˆ†ã‹ã‚‹ã‚ˆã†ãªæŒ‡æ¨™ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿã€

âš ï¸ **3. å‰ææ¡ä»¶ãƒ»åˆ¶ç´„ï¼ˆäºˆç®—ã€äººå“¡ã€æœŸé–“ãªã©ï¼‰**
    ãƒ»**ç¢ºèªãƒã‚¤ãƒ³ãƒˆ**: ç›®çš„é”æˆã‚’é˜»å®³ã™ã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹åˆ¶ç´„ã¯ä½•ã‹ï¼Ÿãã‚Œã‚‰ã®åˆ¶ç´„ã¯æœ¬å½“ã«å‹•ã‹ã›ãªã„ã®ã‹ï¼Ÿ
    ãƒ»**æŠ•ã’ã‹ã‘ã‚‹ã¹ãè³ªå•ä¾‹**: ã€Œã“ã®ç›®çš„ã‚’è¿½æ±‚ã™ã‚‹ä¸Šã§ã€ä¸€ç•ªå¤§ããªã€å£ã€ã«ãªã‚Šãã†ãªã‚‚ã®ã¯ä½•ã§ã—ã‚‡ã†ï¼Ÿã€ã€Œäºˆç®—ã‚„æœŸé–“ã«ã¤ã„ã¦ã€æœ¬å½“ã«ã€ã€œä»¥å†…ã€ã§ãªã„ã¨ã„ã‘ã¾ã›ã‚“ã‹ï¼Ÿå°‘ã—æŸ”è»Ÿã«è€ƒãˆã‚‰ã‚Œãªã„ã§ã—ã‚‡ã†ã‹ï¼Ÿã€

ä¸Šè¨˜ã‚’è¸ã¾ãˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã‚’å—ã‘ãŸã‚ãªãŸã®å¿œç­”ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚""",
            input_variables=["context", "user_input"]
        )
        
        messages = [
            SystemMessage(content="ã‚ãªãŸã¯æ€è€ƒæ•´ç†ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹å£æ‰“ã¡ç›¸æ‰‹ã§ã™ã€‚ç­”ãˆã‚„çµè«–ã¯å‡ºã•ãšã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç›®çš„è¨­å®šã®æ€è€ƒã‚’æ•´ç†ã—ã€æ°—ã¥ãã‚’ä¿ƒã™ã“ã¨ã«å¾¹ã—ã¦ãã ã•ã„ã€‚"),
            HumanMessage(content=prompt.format(context=context, user_input=user_input))
        ]
        
        response = self.chat.invoke(messages)
        return response.content.strip()

    def _concept_agent(self, user_input: str, state: FlexiblePolicyState) -> str:
        """ã‚³ãƒ³ã‚»ãƒ—ãƒˆç­–å®šã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆãƒ–ãƒ©ãƒƒã‚·ãƒ¥ã‚¢ãƒƒãƒ—ç‰ˆï¼‰"""
        context = self._build_context_for_step(state, "concept")
        
        prompt = PromptTemplate(
            template="""ã‚ãªãŸã¯æ”¿ç­–ç«‹æ¡ˆã®ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªå£æ‰“ã¡ç›¸æ‰‹ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆã‚’ã€æ›–æ˜§ãªã‚¢ã‚¤ãƒ‡ã‚¢ã‹ã‚‰å…·ä½“çš„ã§èª¬å¾—åŠ›ã®ã‚ã‚‹éª¨å­ã¸ã¨ç£¨ãä¸Šã’ã‚‹å½¹å‰²ã‚’æ‹…ã„ã¾ã™ã€‚å˜ãªã‚‹ã‚³ãƒ³ã‚»ãƒ—ãƒˆã®ç¾…åˆ—ã§ã¯ãªãã€ãã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆãŒã€Œãªãœæœ‰åŠ¹ãªã®ã‹ã€ã¨ã„ã†æ ¹æ‹ ã‚’å•ã„ã€ãƒªã‚¹ã‚¯ã¾ã§å«ã‚ã¦æ¤œè¨ã‚’ä¿ƒã—ã¦ãã ã•ã„ã€‚

ã€ã“ã‚Œã¾ã§ã®æ¤œè¨å†…å®¹ã€‘
{context}

ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®å…¥åŠ›ã€‘
{user_input}

ã€ã‚ãªãŸã®æ€è€ƒãƒ—ãƒ­ã‚»ã‚¹ã¨æŒ¯ã‚‹èˆã„ã€‘
1.  **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ„å›³ç†è§£**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåŸºæœ¬æ–¹é‡ã€æ ¹æ‹ ã€ãƒªã‚¹ã‚¯ã®ã©ã®ç‚¹ã«ã¤ã„ã¦è©±ã—ã¦ã„ã‚‹ã‹ã‚’æŠŠæ¡ã™ã‚‹ã€‚
2.  **ã‚³ãƒ³ã‚»ãƒ—ãƒˆã®å…·ä½“åŒ–**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¤ãƒ‡ã‚¢ãŒã€èª°ã«ã©ã‚“ãªä¾¡å€¤ã‚’å±Šã‘ã‚‹ã®ã‹ã€ãã®æ ¸å¿ƒéƒ¨åˆ†ã‚’æ˜ç¢ºã«ã™ã‚‹ã€‚
3.  **å¯¾è©±ã®æ–¹å‘æ€§æç¤º**: 3ã¤ã®ã‚´ãƒ¼ãƒ«é …ç›®ã«æ²¿ã£ã¦ã€ã‚³ãƒ³ã‚»ãƒ—ãƒˆã®æœ‰åŠ¹æ€§ã¨å®Ÿç¾å¯èƒ½æ€§ã‚’æ¤œè¨¼ã™ã‚‹ãŸã‚ã®è³ªå•ã‚’æç¤ºã™ã‚‹ã€‚
4.  **å•ã„ã®å…·ä½“åŒ–**: ã€Œãã®ã‚¢ã‚¤ãƒ‡ã‚¢ãŒæœ¬å½“ã«æ©Ÿèƒ½ã™ã‚‹ã‹ï¼Ÿã€ã‚’è€ƒãˆã‚‹ãŸã‚ã®å…·ä½“çš„ãªè³ªå•ï¼ˆã€Œä»–ã®äº‹ä¾‹ã§ã¯ã©ã†ã§ã—ãŸã‹ï¼Ÿã€ã€Œã“ã®ãƒªã‚¹ã‚¯ã¯ç„¡è¦–ã§ãã¾ã™ã‹ï¼Ÿã€ï¼‰ã‚’æŠ•ã’ã‹ã‘ã‚‹ã€‚

ã€é”æˆã™ã¹ãã‚´ãƒ¼ãƒ«ã€‘
ã“ã®å¯¾è©±ã‚’é€šã˜ã¦ã€æœ€çµ‚çš„ã«ä»¥ä¸‹ã®3ã¤ã®é …ç›®ãŒã¾ã¨ã¾ã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚
ğŸ’¡ **1. åŸºæœ¬æ–¹é‡ï¼ˆã©ã‚“ãªä¾¡å€¤ã‚’èª°ã«ã€ã©ã†å±Šã‘ã‚‹ã‹ï¼‰**
    ãƒ»**ç¢ºèªãƒã‚¤ãƒ³ãƒˆ**: ã‚¿ãƒ¼ã‚²ãƒƒãƒˆï¼ˆå—ç›Šè€…ï¼‰ã¯èª°ã‹ï¼Ÿãã®äººãŸã¡ã«æä¾›ã™ã‚‹ã€Œæ ¸ã¨ãªã‚‹ä¾¡å€¤ã€ã¯ä½•ã‹ï¼Ÿãã®ä¾¡å€¤ã‚’å±Šã‘ã‚‹å…·ä½“çš„ãªæ‰‹æ®µã¯ï¼Ÿ
    ãƒ»**æŠ•ã’ã‹ã‘ã‚‹ã¹ãè³ªå•ä¾‹**: ã€Œã“ã®æ–½ç­–ãŒæœ€ã‚‚éŸ¿ãã®ã¯ã€å…·ä½“çš„ã«ã©ã‚“ãªäººãŸã¡ã§ã—ã‚‡ã†ã‹ï¼Ÿã€ã€Œæä¾›ã™ã‚‹ã€ä¾¡å€¤ã€ã‚’ã€ä¸€è¨€ã§è¡¨ã™ã¨ã—ãŸã‚‰ä½•ã«ãªã‚Šã¾ã™ã‹ï¼Ÿã€

ğŸ“š **2. æ–¹é‡ã®æ ¹æ‹ ãƒ»ç¤ºå”†ï¼ˆèª¿æŸ»ã€äº‹ä¾‹ã€å°‚é–€å®¶æ„è¦‹ãªã©ï¼‰**
    ãƒ»**ç¢ºèªãƒã‚¤ãƒ³ãƒˆ**: ãã®æ–¹é‡ã¯ãªãœæˆåŠŸã™ã‚‹ã¨è¨€ãˆã‚‹ã®ã‹ï¼Ÿå®¢è¦³çš„ãªãƒ‡ãƒ¼ã‚¿ã‚„å…ˆè¡Œäº‹ä¾‹ã€å°‚é–€å®¶ã®æ„è¦‹ãªã©ã§è£ä»˜ã‘ã‚‰ã‚Œã‚‹ã‹ï¼Ÿ
    ãƒ»**æŠ•ã’ã‹ã‘ã‚‹ã¹ãè³ªå•ä¾‹**: ã€Œã“ã®æ–¹é‡ã‚’è€ƒãˆãŸãã£ã‹ã‘ã¯ã€ã©ã‚“ãªèª¿æŸ»çµæœã‚„æˆåŠŸäº‹ä¾‹ã§ã—ãŸã‹ï¼Ÿã€ã€Œé¡ä¼¼ã®å–ã‚Šçµ„ã¿ã§ã€å¤±æ•—ã—ãŸã‚±ãƒ¼ã‚¹ã‹ã‚‰å­¦ã¹ã‚‹ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿã€

âš ï¸ **3. ä¸»è¦ãƒªã‚¹ã‚¯ã¨æ‰“ã¡æ‰‹ï¼ˆä»£æ›¿æ¡ˆã€å®Ÿé¨“è¨­è¨ˆï¼‰**
    ãƒ»**ç¢ºèªãƒã‚¤ãƒ³ãƒˆ**: æƒ³å®šã•ã‚Œã‚‹ãƒªã‚¹ã‚¯ã¯ä½•ã‹ï¼Ÿãã®ãƒªã‚¹ã‚¯ã‚’å›é¿ãƒ»è»½æ¸›ã™ã‚‹ãŸã‚ã®å¯¾ç­–ã¯ä½•ã‹ï¼Ÿ
    ãƒ»**æŠ•ã’ã‹ã‘ã‚‹ã¹ãè³ªå•ä¾‹**: ã€Œã‚‚ã—ã€‡ã€‡ã¨ã„ã†å•é¡ŒãŒèµ·ããŸå ´åˆã€ã©ã†å¯¾å‡¦ã™ã‚‹äºˆå®šã§ã™ã‹ï¼Ÿã€ã€Œã„ããªã‚Šå¤§è¦æ¨¡ã«å§‹ã‚ã‚‹ã®ã§ã¯ãªãã€å°ã•ãªãƒ‘ã‚¤ãƒ­ãƒƒãƒˆç‰ˆã§æ¤œè¨¼ã™ã‚‹æ–¹æ³•ã¯è€ƒãˆã‚‰ã‚Œã¾ã™ã‹ï¼Ÿã€

ä¸Šè¨˜ã‚’è¸ã¾ãˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã‚’å—ã‘ãŸã‚ãªãŸã®å¿œç­”ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚""",
            input_variables=["context", "user_input"]
        )
        
        messages = [
            SystemMessage(content="ã‚ãªãŸã¯æ€è€ƒæ•´ç†ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹å£æ‰“ã¡ç›¸æ‰‹ã§ã™ã€‚ç­”ãˆã‚„çµè«–ã¯å‡ºã•ãšã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚³ãƒ³ã‚»ãƒ—ãƒˆæ¤œè¨ã®æ€è€ƒã‚’æ•´ç†ã—ã€æ°—ã¥ãã‚’ä¿ƒã™ã“ã¨ã«å¾¹ã—ã¦ãã ã•ã„ã€‚"),
            HumanMessage(content=prompt.format(context=context, user_input=user_input))
        ]
        
        response = self.chat.invoke(messages)
        return response.content.strip()

    def _plan_agent(self, user_input: str, state: FlexiblePolicyState) -> str:
        """æ–½ç­–ç«‹æ¡ˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆãƒ–ãƒ©ãƒƒã‚·ãƒ¥ã‚¢ãƒƒãƒ—ç‰ˆï¼‰"""
        context = self._build_context_for_step(state, "plan")
        
        prompt = PromptTemplate(
            template="""ã‚ãªãŸã¯æ”¿ç­–ç«‹æ¡ˆã®ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªå£æ‰“ã¡ç›¸æ‰‹ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ–½ç­–ã‚’ã€çµµã«æã„ãŸé¤…ã§çµ‚ã‚ã‚‰ã›ãªã„ã‚ˆã†ã€å®Ÿè¡Œå¯èƒ½æ€§ã¨åŠ¹æœã‚’å³ã—ãæ¤œè¨¼ã™ã‚‹å½¹å‰²ã‚’æ‹…ã„ã¾ã™ã€‚è¨ˆç”»ã®ç©´ã‚’è¦‹ã¤ã‘ã€ã‚ˆã‚Šç¾å®Ÿçš„ã§åŠ¹æœçš„ãªãƒ—ãƒ©ãƒ³ã¸ã¨ç£¨ãä¸Šã’ã‚‹ã‚ˆã†å°ã„ã¦ãã ã•ã„ã€‚

ã€ã“ã‚Œã¾ã§ã®æ¤œè¨å†…å®¹ã€‘
{context}

ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®å…¥åŠ›ã€‘
{user_input}

ã€ã‚ãªãŸã®æ€è€ƒãƒ—ãƒ­ã‚»ã‚¹ã¨æŒ¯ã‚‹èˆã„ã€‘
1.  **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ„å›³ç†è§£**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç™ºè¨€ãŒã€æ–½ç­–ã®æ¦‚è¦ã€ä½“åˆ¶ãƒ»ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã€ã‚³ã‚¹ãƒˆãƒ»åŠ¹æœã®ã©ã®ç‚¹ã«ç„¦ç‚¹ã‚’å½“ã¦ã¦ã„ã‚‹ã‹ã‚’æŠŠæ¡ã™ã‚‹ã€‚
2.  **è¨ˆç”»ã®æ•´åˆæ€§æ¤œè¨¼**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ–½ç­–ãŒã€ã“ã‚Œã¾ã§ã®åˆ†æã€ç›®çš„ã€ã‚³ãƒ³ã‚»ãƒ—ãƒˆã¨çŸ›ç›¾ã—ã¦ã„ãªã„ã‹ã‚’ç¢ºèªã™ã‚‹ã€‚
3.  **å¯¾è©±ã®æ–¹å‘æ€§æç¤º**: 3ã¤ã®ã‚´ãƒ¼ãƒ«é …ç›®ã«æ²¿ã£ã¦ã€è¨ˆç”»ã®ç¾å®Ÿæ€§ã‚’é«˜ã‚ã‚‹ãŸã‚ã®è³ªå•ã‚’æç¤ºã™ã‚‹ã€‚
4.  **å•ã„ã®å…·ä½“åŒ–**: ã€Œãã‚Œã¯ã©ã†ã‚„ã£ã¦å®Ÿç¾ã™ã‚‹ã®ã‹ï¼Ÿã€ã€Œæœ¬å½“ã«ãã®åŠ¹æœãŒå‡ºã‚‹ã®ã‹ï¼Ÿã€ã¨ã„ã£ãŸã€å®Ÿè¡Œãƒ•ã‚§ãƒ¼ã‚ºã‚’å…·ä½“çš„ã«ã‚¤ãƒ¡ãƒ¼ã‚¸ã•ã›ã‚‹è³ªå•ã‚’æŠ•ã’ã‹ã‘ã‚‹ã€‚

ã€é”æˆã™ã¹ãã‚´ãƒ¼ãƒ«ã€‘
ã“ã®å¯¾è©±ã‚’é€šã˜ã¦ã€æœ€çµ‚çš„ã«ä»¥ä¸‹ã®3ã¤ã®é …ç›®ãŒã¾ã¨ã¾ã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚
ğŸš€ **1. ä¸»ãªæ–½ç­–ï¼ˆ3ã€œ5å€‹ï¼‰ã®æ¦‚è¦ã¨ç‹™ã„**
    ãƒ»**ç¢ºèªãƒã‚¤ãƒ³ãƒˆ**: æ–½ç­–ã¯ã‚³ãƒ³ã‚»ãƒ—ãƒˆã«æ²¿ã£ã¦ã„ã‚‹ã‹ï¼Ÿãã‚Œãã‚Œã®æ–½ç­–ãŒã€ã©ã†ã‚„ã£ã¦ç›®çš„é”æˆã«è²¢çŒ®ã™ã‚‹ã®ã‹ï¼Ÿ
    ãƒ»**æŠ•ã’ã‹ã‘ã‚‹ã¹ãè³ªå•ä¾‹**: ã€Œãã®æ–½ç­–ã¯ã€æƒ³å®šã—ã¦ã„ã‚‹ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ã©ã†å±Šãã¾ã™ã‹ï¼Ÿã€ã€Œãªãœãã®æ–½ç­–ãŒç›®çš„é”æˆã«ä¸å¯æ¬ ã ã¨ãŠè€ƒãˆã§ã™ã‹ï¼Ÿã€

ğŸ‘¥ **2. ä½“åˆ¶ãƒ»å½¹å‰²åˆ†æ‹…ãƒ»ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«**
    ãƒ»**ç¢ºèªãƒã‚¤ãƒ³ãƒˆ**: èª°ãŒã€ã„ã¤ã€ä½•ã‚’ã™ã‚‹ã®ã‹ã€å½¹å‰²ã¯æ˜ç¢ºã‹ï¼Ÿå¤–éƒ¨ã®é–¢ä¿‚è€…ã¨ã®é€£æºã¯è€ƒæ…®ã•ã‚Œã¦ã„ã‚‹ã‹ï¼Ÿ
    ãƒ»**æŠ•ã’ã‹ã‘ã‚‹ã¹ãè³ªå•ä¾‹**: ã€Œã“ã®è¨ˆç”»ã‚’é€²ã‚ã‚‹ä¸Šã§ã€ç‰¹ã«ã€å”åŠ›ã€ãŒå¿…è¦ã«ãªã‚Šãã†ãªäººã‚„çµ„ç¹”ã¯èª°ã§ã—ã‚‡ã†ã‹ï¼Ÿã€ã€Œã“ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ã€ç¾å®Ÿçš„ãªãƒªã‚½ãƒ¼ã‚¹ã§å®Ÿè¡Œå¯èƒ½ã§ã—ã‚‡ã†ã‹ï¼Ÿã€

ğŸ’° **3. æ¦‚ç®—ã‚³ã‚¹ãƒˆãƒ»åŠ¹æœè¦‹è¾¼ã¿ï¼ˆæ ¹æ‹ ã‚‚ï¼‰**
    ãƒ»**ç¢ºèªãƒã‚¤ãƒ³ãƒˆ**: è²»ç”¨ã¨æœŸå¾…åŠ¹æœã®ãƒãƒ©ãƒ³ã‚¹ã¯ã©ã†ã‹ï¼ŸåŠ¹æœã¯ã©ã®ã‚ˆã†ã«è¨ˆæ¸¬ã™ã‚‹ã®ã‹ï¼Ÿ
    ãƒ»**æŠ•ã’ã‹ã‘ã‚‹ã¹ãè³ªå•ä¾‹**: ã€Œãã®ã‚³ã‚¹ãƒˆã¯ã€ã©ã‚“ãªå†…è¨³ã§æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿã€ã€ŒæœŸå¾…ã—ã¦ã„ã‚‹åŠ¹æœãŒæƒ³å®šé€šã‚Šå‡ºãªã‹ã£ãŸå ´åˆã€ã©ã®ã‚ˆã†ã«è»Œé“ä¿®æ­£ã—ã¾ã™ã‹ï¼Ÿã€

ä¸Šè¨˜ã‚’è¸ã¾ãˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã‚’å—ã‘ãŸã‚ãªãŸã®å¿œç­”ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚""",
            input_variables=["context", "user_input"]
        )
        
        messages = [
            SystemMessage(content="ã‚ãªãŸã¯æ€è€ƒæ•´ç†ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹å£æ‰“ã¡ç›¸æ‰‹ã§ã™ã€‚ç­”ãˆã‚„çµè«–ã¯å‡ºã•ãšã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¨ˆç”»ç­–å®šã®æ€è€ƒã‚’æ•´ç†ã—ã€æ°—ã¥ãã‚’ä¿ƒã™ã“ã¨ã«å¾¹ã—ã¦ãã ã•ã„ã€‚"),
            HumanMessage(content=prompt.format(context=context, user_input=user_input))
        ]
        
        response = self.chat.invoke(messages)
        return response.content.strip()

    def _proposal_agent(self, user_input: str, state: FlexiblePolicyState) -> str:
        """è³‡æ–™ä½œæˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆãƒ–ãƒ©ãƒƒã‚·ãƒ¥ã‚¢ãƒƒãƒ—ç‰ˆï¼‰"""
        context = self._build_context_for_step(state, "proposal")
        
        prompt = PromptTemplate(
            template="""ã‚ãªãŸã¯æ”¿ç­–ç«‹æ¡ˆã®ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«ãªå£æ‰“ã¡ç›¸æ‰‹ã§ã™ã€‚ã“ã‚Œã¾ã§ã®è­°è«–ã‚’ã€æ„æ€æ±ºå®šè€…ãŒç´å¾—ã—ã€è¡Œå‹•ã«ç§»ã—ãŸããªã‚‹ã‚ˆã†ãªèª¬å¾—åŠ›ã®ã‚ã‚‹è³‡æ–™ã«ã¾ã¨ã‚ã‚‹å½¹å‰²ã‚’æ‹…ã„ã¾ã™ã€‚å˜ãªã‚‹æƒ…å ±ã®ç¾…åˆ—ã§ã¯ãªãã€ãƒ­ã‚¸ãƒƒã‚¯ã®é£›èºã‚„èª¬æ˜ã®ä¸è¶³ãŒãªã„ã‹ã€ç¬¬ä¸‰è€…ã®è¦–ç‚¹ã§å³ã—ããƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚

ã€ã“ã‚Œã¾ã§ã®æ¤œè¨å†…å®¹ã€‘
{context}

ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®å…¥åŠ›ã€‘
{user_input}

ã€ã‚ãªãŸã®æ€è€ƒãƒ—ãƒ­ã‚»ã‚¹ã¨æŒ¯ã‚‹èˆã„ã€‘
1.  **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ„å›³ç†è§£**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒææ¡ˆã®ã‚µãƒãƒªãƒ¼ã€æ„æ€æ±ºå®šè€…ã¸ã®ã‚¢ãƒ”ãƒ¼ãƒ«ã€æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ã©ã®ç‚¹ã«ã¤ã„ã¦è©±ã—ã¦ã„ã‚‹ã‹ã‚’æŠŠæ¡ã™ã‚‹ã€‚
2.  **ãƒ­ã‚¸ãƒƒã‚¯ã®ç©´ã‚’è¦‹ã¤ã‘ã‚‹**: ã“ã‚Œã¾ã§ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆåˆ†æâ†’ç›®çš„â†’ã‚³ãƒ³ã‚»ãƒ—ãƒˆâ†’æ–½ç­–ï¼‰ã§ã€è©±ã®ç¹‹ãŒã‚ŠãŒå¼±ã„éƒ¨åˆ†ã‚„ã€æ ¹æ‹ ãŒä¸è¶³ã—ã¦ã„ã‚‹ç‚¹ã‚’æŒ‡æ‘˜ã™ã‚‹ã€‚
3.  **å¯¾è©±ã®æ–¹å‘æ€§æç¤º**: 3ã¤ã®ã‚´ãƒ¼ãƒ«é …ç›®ã«æ²¿ã£ã¦ã€ææ¡ˆã®èª¬å¾—åŠ›ã‚’é«˜ã‚ã‚‹ãŸã‚ã®è³ªå•ã‚’æç¤ºã™ã‚‹ã€‚
4.  **å•ã„ã®å…·ä½“åŒ–**: æ„æ€æ±ºå®šè€…ã®è¦–ç‚¹ã«ç«‹ã¡ã€ã€Œã“ã®èª¬æ˜ã§æœ¬å½“ã«ç†è§£ã—ã¦ã‚‚ã‚‰ãˆã‚‹ã‹ï¼Ÿã€ã€Œæ‡¸å¿µç‚¹ã¯ãªã„ã‹ï¼Ÿã€ã¨ã„ã£ãŸé‹­ã„è³ªå•ã‚’æŠ•ã’ã‹ã‘ã‚‹ã€‚

ã€é”æˆã™ã¹ãã‚´ãƒ¼ãƒ«ã€‘
ã“ã®å¯¾è©±ã‚’é€šã˜ã¦ã€æœ€çµ‚çš„ã«ä»¥ä¸‹ã®3ã¤ã®é …ç›®ãŒã¾ã¨ã¾ã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚
ğŸ“ **1. ææ¡ˆã®ã‚µãƒãƒªãƒ¼ï¼ˆèƒŒæ™¯â†’èª²é¡Œâ†’è§£æ±ºâ†’åŠ¹æœâ†’ä½“åˆ¶ï¼‰**
    ãƒ»**ç¢ºèªãƒã‚¤ãƒ³ãƒˆ**: ç‰©èªã¨ã—ã¦ã®æµã‚Œã¯ã‚¹ãƒ ãƒ¼ã‚ºã‹ï¼Ÿå„é …ç›®é–“ã®å› æœé–¢ä¿‚ã¯æ˜ç¢ºã‹ï¼Ÿ
    ãƒ»**æŠ•ã’ã‹ã‘ã‚‹ã¹ãè³ªå•ä¾‹**: ã€Œã“ã®èƒŒæ™¯ã‹ã‚‰ã€ãªãœã“ã®èª²é¡ŒãŒå°ãå‡ºã•ã‚Œã‚‹ã®ã‹ï¼Ÿã€ã€Œè§£æ±ºç­–ã¯ã€æç¤ºã—ãŸèª²é¡Œã«ç›´æ¥çš„ã«å¿œãˆã‚‹ã‚‚ã®ã«ãªã£ã¦ã„ã¾ã™ã‹ï¼Ÿã€

ğŸ’¼ **2. æ„æ€æ±ºå®šè€…ã®é–¢å¿ƒï¼ˆè²»ç”¨å¯¾åŠ¹æœã€ãƒªã‚¹ã‚¯ã€è²¬ä»»åˆ†æ‹…ï¼‰**
    ãƒ»**ç¢ºèªãƒã‚¤ãƒ³ãƒˆ**: æ„æ€æ±ºå®šè€…ãŒæœ€ã‚‚æ°—ã«ã™ã‚‹ã§ã‚ã‚ã†ã€ŒãŠé‡‘ã€ã¨ã€Œãƒªã‚¹ã‚¯ã€ã«ã¤ã„ã¦ã€ååˆ†ãªèª¬æ˜ãŒã‚ã‚‹ã‹ï¼Ÿ
    ãƒ»**æŠ•ã’ã‹ã‘ã‚‹ã¹ãè³ªå•ä¾‹**: ã€Œã“ã®ææ¡ˆã‚’æ‰¿èªã™ã‚‹ã“ã¨ã§ã€æ„æ€æ±ºå®šè€…ã«ã¯ã©ã‚“ãªãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã¾ã™ã‹ï¼Ÿã€ã€Œã‚‚ã—å¤±æ•—ã—ãŸå ´åˆã€èª°ãŒã€ã©ã®ã‚ˆã†ã«è²¬ä»»ã‚’å–ã‚‹ã‹æ˜ç¢ºã«ãªã£ã¦ã„ã¾ã™ã‹ï¼Ÿã€

â¡ï¸ **3. æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆæ‰¿èªãƒ—ãƒ­ã‚»ã‚¹ã€é–¢ä¿‚è€…èª¬æ˜ã€PoCæº–å‚™ãªã©ï¼‰**
    ãƒ»**ç¢ºèªãƒã‚¤ãƒ³ãƒˆ**: æ‰¿èªã‚’å¾—ãŸå¾Œã€ã™ãã«ä½•ã‚’ã™ã¹ãã‹ãŒæ˜ç¢ºã‹ï¼Ÿé–¢ä¿‚è€…ã¸ã®èª¬æ˜ã¯æº–å‚™ã•ã‚Œã¦ã„ã‚‹ã‹ï¼Ÿ
    ãƒ»**æŠ•ã’ã‹ã‘ã‚‹ã¹ãè³ªå•ä¾‹**: ã€Œææ¡ˆã‚’å—ã‘å…¥ã‚Œã‚‹å´ãŒã€æ¬¡ã«å…·ä½“çš„ã«ä½•ã‚’ã™ã‚Œã°è‰¯ã„ã‹ã€æ˜ç¢ºã«ç¤ºã•ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿã€ã€Œã“ã®ææ¡ˆã«åå¯¾ã™ã‚‹å¯èƒ½æ€§ã®ã‚ã‚‹é–¢ä¿‚è€…ã¯ã„ã¾ã™ã‹ï¼Ÿãã®äººãŸã¡ã«ã¯ã€ã©ã†èª¬æ˜ã—ã¾ã™ã‹ï¼Ÿã€

ä¸Šè¨˜ã‚’è¸ã¾ãˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã‚’å—ã‘ãŸã‚ãªãŸã®å¿œç­”ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚""",
            input_variables=["context", "user_input"]
        )
        
        messages = [
            SystemMessage(content="ã‚ãªãŸã¯æ€è€ƒæ•´ç†ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹å£æ‰“ã¡ç›¸æ‰‹ã§ã™ã€‚ç­”ãˆã‚„çµè«–ã¯å‡ºã•ãšã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ææ¡ˆä½œæˆã®æ€è€ƒã‚’æ•´ç†ã—ã€æ°—ã¥ãã‚’ä¿ƒã™ã“ã¨ã«å¾¹ã—ã¦ãã ã•ã„ã€‚"),
            HumanMessage(content=prompt.format(context=context, user_input=user_input))
        ]
        
        response = self.chat.invoke(messages)
        return response.content.strip()

    def process_flexible(self, user_input: str, session_id: str, current_step: str, project_id: str = None) -> Dict[str, Any]:
        """
        ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã‚’å—ã‘ä»˜ã‘ã€æ„å›³ã«å¿œã˜ã¦å‡¦ç†ã‚’æŒ¯ã‚Šåˆ†ã‘ã‚‹ãƒ¡ã‚¤ãƒ³ãƒ¡ã‚½ãƒƒãƒ‰
        """
        state = self._get_session_state(session_id, project_id)
        
        # ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ„å›³ã‚’åˆ¤æ–­
        intent = self._classify_user_intent(user_input, state)
        
        # æ„å›³ã«å¿œã˜ã¦å‡¦ç†ã‚’åˆ†å²
        if intent == 'fact_search_request' and state["fact_search_results"]:
            result = self._fact_summary_agent(user_input, state)
            self._update_session_state(session_id, current_step, result, user_input)
            return {"result": result, "step": current_step, "type": "fact_summary", "full_state": state}
            
        elif intent == 'summary_request':
            result = self._overall_summary_agent(user_input, state)
            self._update_session_state(session_id, current_step, result, user_input)
            return {"result": result, "step": current_step, "type": "overall_summary", "full_state": state}

        # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ˜ç¤ºçš„ã«ã‚¹ãƒ†ãƒƒãƒ—ã‚’æŒ‡å®šã—ãŸå ´åˆã€ãã¡ã‚‰ã‚’å„ªå…ˆ
        # ä¾‹ï¼šã€Œæ¬¡ã¯ç›®çš„æ•´ç†ã‹ã‚‰å§‹ã‚ãŸã„ã€ãªã©
        step_change_request = self._check_step_change_request(user_input)
        if step_change_request:
            current_step = step_change_request
        
        # æ±ç”¨çš„ãªã‚¿ã‚¹ã‚¯ã«è©²å½“ã—ãªã„å ´åˆã€ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—ã®å¯¾è©±ã‚’ç¶™ç¶š
        result = self.agent_map[current_step](user_input, state)
        self._update_session_state(session_id, current_step, result, user_input)
        return {"result": result, "step": current_step, "type": "step_action", "full_state": state}
    
    def _check_step_change_request(self, user_input: str) -> Optional[str]:
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¹ãƒ†ãƒƒãƒ—å¤‰æ›´ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¦ã„ã‚‹ã‹ã‚’åˆ¤æ–­"""
        # ç°¡æ˜“çš„ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒãƒ³ã‚°
        user_input_lower = user_input.lower()
        if "ç¾çŠ¶åˆ†æ" in user_input or "åˆ†æã‹ã‚‰" in user_input_lower:
            return "analysis"
        elif "ç›®çš„æ•´ç†" in user_input or "ç›®çš„ã‹ã‚‰" in user_input_lower:
            return "objective"
        elif "ã‚³ãƒ³ã‚»ãƒ—ãƒˆ" in user_input or "ã‚³ãƒ³ã‚»ãƒ—ãƒˆã‹ã‚‰" in user_input_lower:
            return "concept"
        elif "æ–½ç­–" in user_input or "æ–½ç­–ç«‹æ¡ˆ" in user_input or "è¨ˆç”»" in user_input:
            return "plan"
        elif "è³‡æ–™ä½œæˆ" in user_input or "ææ¡ˆæ›¸" in user_input:
            return "proposal"
        return None

    def get_session_state(self, session_id: str) -> Dict[str, Any]:
        """ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’å–å¾—"""
        if session_id not in self.state_storage:
            return {"error": "ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"}
        
        state = self.state_storage[session_id]
        return {
            "session_id": session_id,
            "project_id": state["project_id"],
            "analysis_result": state["analysis_result"],
            "objective_result": state["objective_result"],
            "concept_result": state["concept_result"],
            "plan_result": state["plan_result"],
            "proposal_result": state["proposal_result"],
            "last_updated_step": state["last_updated_step"],
            "step_timestamps": state["step_timestamps"]
        }